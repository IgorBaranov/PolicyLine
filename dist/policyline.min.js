module.exports=function(t){function e(n){if(r[n])return r[n].exports;var o=r[n]={i:n,l:!1,exports:{}};return t[n].call(o.exports,o,o.exports,e),o.l=!0,o.exports}var r={};return e.m=t,e.c=r,e.d=function(t,r,n){e.o(t,r)||Object.defineProperty(t,r,{configurable:!1,enumerable:!0,get:n})},e.n=function(t){var r=t&&t.__esModule?function(){return t.default}:function(){return t};return e.d(r,"a",r),r},e.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},e.p="",e(e.s=2)}([function(t,e,r){"use strict";function n(t,e,r){return e in t?Object.defineProperty(t,e,{value:r,enumerable:!0,configurable:!0,writable:!0}):t[e]=r,t}function o(t){return t instanceof Date?t:new Date(t)}function a(t,e,r){var o;f[t]=(o={},n(o,i,e),n(o,l,r),o)}function u(t){delete f[t]}Object.defineProperty(e,"__esModule",{value:!0});var i=Symbol(),l=Symbol(),f={radius:n({},l,function(t,e,r){return t.leftIsData?e.radius=t.leftValue:e.radius=t.rightValue,!0}),inArea:n({},l,function(t,e,r){function n(t){return t*(Math.PI/180)}var o=function(t,e,r,o){var a=n(r-t),u=n(o-e),i=Math.sin(a/2)*Math.sin(a/2)+Math.cos(n(t))*Math.cos(n(r))*Math.sin(u/2)*Math.sin(u/2);return 2*Math.atan2(Math.sqrt(i),Math.sqrt(1-i))*6371}(t.rightValue[0],t.rightValue[1],t.leftValue[0],t.leftValue[1]);return e.radius>=o}),or:n({},l,function(t,e,r){if(e.container=e.container||{},e.container[r]=t.result,t.result)for(var n in e.container)e.container[n]=!0;return e.container}),toInt:function(t){return parseInt(t,10)},toString:function(t){return t+""},trim:function(t){return t.trim()},uppercase:function(t){return t.toUpperCase()},lowercase:function(t){return t.toLowerCase()},minute:function(t){return o(t).getMinutes()},day:function(t){return o(t).getDate()},hour:function(t){return o(t).getHours()},weekday:function(t){return o(t).getDay()},month:function(t){return o(t).getMonth()},year:function(t){return o(t).getFullYear()},regExp:function(t){var e=t.lastIndexOf("/"),r=t.substring(0,e),n=t.substring(e+1,t.length);return n&&n.length?new RegExp(r,n):new RegExp(r)}},c={prefix:i,postfix:l,register:a,unregister:u,get list(){return f}};e.default=c},function(t,e,r){"use strict";function n(t,e){var r=e.split("."),n=t,o=!0,a=!1,u=void 0;try{for(var i,l=r[Symbol.iterator]();!(o=(i=l.next()).done);o=!0){var f=i.value;try{n=n[f]}catch(t){n=null;break}}}catch(t){a=!0,u=t}finally{try{!o&&l.return&&l.return()}finally{if(a)throw u}}return n}function o(t,e,r){var o=void 0,a=void 0,i=e.value;e.isDIObj&&(i=n(t,i));var l=!0,f=!1,c=void 0;try{for(var s,v=e.mutators[Symbol.iterator]();!(l=(s=v.next()).done);l=!0){var d=s.value;e.isDIObj&&(r[e.value]=r[e.value]||{},o=r[e.value]),a=u.default.list[d],a&&"function"!=typeof a&&(a=a[u.default.prefix]),i=a?a(i,o):i}}catch(t){f=!0,c=t}finally{try{!l&&v.return&&v.return()}finally{if(f)throw c}}return i}Object.defineProperty(e,"__esModule",{value:!0}),e.extract=void 0;var a=r(0),u=function(t){return t&&t.__esModule?t:{default:t}}(a);e.extract=o},function(t,e,r){"use strict";function n(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function o(t,e){return t.isDIObj&&t.value.indexOf&&0===t.value.indexOf(e)}Object.defineProperty(e,"__esModule",{value:!0}),e.Adapter=e.Mutator=e.Operator=e.Policy=void 0;var a=function(){function t(t,e){for(var r=0;r<e.length;r++){var n=e[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}return function(e,r,n){return r&&t(e.prototype,r),n&&t(e,n),e}}(),u=r(3),i=r(5),l=Symbol(),f="user.",c="resource.",s=function(){function t(e){n(this,t);var r=void 0,a=[],i=u.Operator.list;this[l]={effect:"deny"!==e.effect,target:[],condition:[],watcher:[],lastData:null};var s=!0,v=!1,d=void 0;try{for(var p,y=e.target[Symbol.iterator]();!(s=(p=y.next()).done);s=!0){var h=p.value;a.push((0,u.parseExp)(h))}}catch(t){v=!0,d=t}finally{try{!s&&y.return&&y.return()}finally{if(v)throw d}}var b=!0,g=!1,m=void 0;try{for(var x,O=a[Symbol.iterator]();!(b=(x=O.next()).done);b=!0){var j=x.value;o(j.left,c)?this[l].condition.push(j):o(j.right,c)?(r=j.right,j.right=j.left,j.left=r,i[j.operator].reverse&&(j.operator=i[j.operator].reverse),this[l].condition.push(j)):this[l].target.push(j),o(j.left,f)||o(j.right,f)}}catch(t){g=!0,m=t}finally{try{!b&&O.return&&O.return()}finally{if(g)throw m}}}return a(t,[{key:"check",value:function(t){var e={},r={},n=void 0,o=void 0;this[l].lastData=t;var a=!0,i=!1,f=void 0;try{for(var c,s=this[l].target[Symbol.iterator]();!(a=(c=s.next()).done);a=!0){var v=c.value;n=Math.floor(65536*(1+Math.random())).toString(16).substring(1),o=(0,u.executeExp)(t,v,e,n),"boolean"==typeof o?r[n]=o:Object.assign(r,o)}}catch(t){i=!0,f=t}finally{try{!a&&s.return&&s.return()}finally{if(i)throw f}}var d=!0;return Object.values(r).forEach(function(t){d=d&&t}),this[l].effect?d:!d}},{key:"getConditions",value:function(t){"function"!=typeof t&&(t=i.Adapter.MongoJSONb);var e={},r=[],n=this[l].lastData,o=!0,a=!1,u=void 0;try{for(var f,c=this[l].condition[Symbol.iterator]();!(o=(f=c.next()).done);o=!0){var s=f.value;r.push((0,i.prepareCondition)(n,s,e))}}catch(t){a=!0,u=t}finally{try{!o&&c.return&&c.return()}finally{if(a)throw u}}return t(r)}}]),t}();e.Policy=s,e.Operator=u.Operator,e.Mutator=u.Mutator,e.Adapter=i.Adapter},function(t,e,r){"use strict";function n(t){return t&&t.__esModule?t:{default:t}}function o(t){var e="Semantic Error in "+t+": \n    Expression should be obj.attr[..mutator](operator)value or object.attribute\n    (user.role~=['admin','user'] , resource.location..radius=100)";throw new Error(e)}function a(t){return t.includes(".")&&(0===t.indexOf("user.")||0===t.indexOf("env.")||0===t.indexOf("action.")||0===t.indexOf("resource."))}function u(t){return t[0]===m&&t[t.length-1]===m&&(t='"'+t.substr(1,t.length-2)+'"'),t}function i(t){var e=t.split(".."),r=e.slice(1,e.length),n=a(e[0]),o=void 0;try{o=n?e[0]:JSON.parse(u(e[0]))}catch(t){var i="Parsing Error: \n\t unknown object - "+e[0]+" in expression";throw new Error(i)}return{isDIObj:n,value:o,mutators:r}}function l(t){var e=d.default.list,r=void 0,n=void 0;for(r in e)if(n=t.split(r),2===n.length)break;return 2===n.length&&b.test(n[0])&&g.test(n[1])||o(t),{origin:t,left:i(n[0]),operator:r,right:i(n[1])}}function f(t,e,r,n){t.mutators.forEach(function(o){var a=y.default.list[o];t.isDIObj&&"object"===(void 0===a?"undefined":s(a))&&a[y.default.postfix]&&(e.result=a[y.default.postfix](e,r[t.value],n))})}function c(t,e,r,n){var o=d.default.list,a=(0,h.extract)(t,e.left,r),u=(0,h.extract)(t,e.right,r),i="*";e.left.isDIObj&&"function"==typeof o[e.operator][e.left.value]?i=e.left.value:e.right.isDIObj&&"function"==typeof o[e.operator][e.right.value]&&(i=e.right.value);var l=o[e.operator][i](a,u),c={leftIsData:!e.left.isDIObj,rightIsData:!e.right.isDIObj,leftValue:a,rightValue:u,result:l};return f(e.left,c,r,n),f(e.right,c,r,n),c.result}Object.defineProperty(e,"__esModule",{value:!0}),e.Mutator=e.Operator=e.executeExp=e.parseExp=void 0;var s="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},v=r(4),d=n(v),p=r(0),y=n(p),h=r(1),b=/^[a-zA-Z]+\.[a-zA-Z]+(?:\.\.[a-zA-Z]+)*/,g=/[^\n]+/,m="'";e.parseExp=l,e.executeExp=c,e.Operator=d.default,e.Mutator=y.default},function(t,e,r){"use strict";function n(t){var e=t.name,r=t.namespace,n=t.implement,o=t.reverse;a[e]=a[e]||{},a[e][r]=n,"*"===r&&o&&(a[e][r].reverse=o);var u={};Object.entries(a).sort(function(t,e){return t[0].length<e[0].length?1:t[0].length>e[0].length?-1:0}).forEach(function(t){u[t[0]]=t[1]}),a=u}function o(t){var e=t.name,r=t.namespace,n=a[e];delete n[r],0===Object.keys(n).length&&delete a[e]}Object.defineProperty(e,"__esModule",{value:!0});var a={"==":{"*":function(t,e){return t===e}},"!=":{"*":function(t,e){return t!==e}},">=":{"*":function(t,e){return t>=e},reverse:"<="},"<=":{"*":function(t,e){return t<=e},reverse:">="},"~=":{"*":function(t,e){return!!Array.isArray(e)&&e.includes(t)},reverse:"~!"},"~!":{"*":function(t,e){return!!Array.isArray(t)&&t.includes(e)},reverse:"~="},"^=":{"*":function(t,e){return!!Array.isArray(e)&&!e.includes(t)},reverse:"^!"},"^!":{"*":function(t,e){return!!Array.isArray(t)&&!t.includes(e)},reverse:"^="},"?=":{"*":function(t,e){return!t||t===e},reverse:"?!"},"?!":{"*":function(t,e){return!e||e===t},reverse:"?="},"=":{"*":function(t,e){return t===e}},">":{"*":function(t,e){return t>e},reverse:"<"},"<":{"*":function(t,e){return t<e},reverse:">"}},u={register:n,unregister:o,get list(){return a}};e.default=u},function(t,e,r){"use strict";function n(t,e,r){return e in t?Object.defineProperty(t,e,{value:r,enumerable:!0,configurable:!0,writable:!0}):t[e]=r,t}function o(t,e,r){var n=(0,a.extract)(t,e.left,r,null),o=(0,a.extract)(t,e.right,r,null);return{attribute:(null===n?e.left.value:n).replace("resource.",""),value:null===o?e.right.value:o,operator:e.operator,mutators:e.left.mutators}}Object.defineProperty(e,"__esModule",{value:!0}),e.prepareCondition=e.Adapter=void 0;var a=r(1),u={"=":"$eq","==":"$eq","!=":"$ne",">=":"$gte",">":"$gt","<=":"$lte","<":"$lt","~=":"$in","^=":"$nin"},i={or:function(t,e,r){e[t.attribute]=e[t.attribute]||{$or:[]},e[t.attribute].$or.push(t.value)},radius:function(t,e,r){r.radius=t.value},inArea:function(t,e,r){e[t.attribute]={$near:{$geometry:{type:"Point",coordinates:t.value},$maxDistance:1e3*r.radius}}}},l={MongoJSONb:function(t){var e={},r={},o=void 0,a=!0,l=!1,f=void 0;try{for(var c,s=t[Symbol.iterator]();!(a=(c=s.next()).done);a=!0){var v=c.value;if(o=v.attribute,v.mutators.length){var d=!0,p=!1,y=void 0;try{for(var h,b=v.mutators[Symbol.iterator]();!(d=(h=b.next()).done);d=!0){var g=h.value;i[g]&&(r[v.attribute]=r[v.attribute]||{},i[g](v,e,r[v.attribute]))}}catch(t){p=!0,y=t}finally{try{!d&&b.return&&b.return()}finally{if(p)throw y}}}else e[o]?e[o][u[v.operator]]=v.value:"="===v.operator?e[o]=v.value:e[o]=n({},u[v.operator],v.value)}}catch(t){l=!0,f=t}finally{try{!a&&s.return&&s.return()}finally{if(l)throw f}}return e}};e.Adapter=l,e.prepareCondition=o}]);