module.exports=function(t){var e={};function r(n){if(e[n])return e[n].exports;var o=e[n]={i:n,l:!1,exports:{}};return t[n].call(o.exports,o,o.exports,r),o.l=!0,o.exports}return r.m=t,r.c=e,r.d=function(t,e,n){r.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:n})},r.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},r.t=function(t,e){if(1&e&&(t=r(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var n=Object.create(null);if(r.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var o in t)r.d(n,o,function(e){return t[e]}.bind(null,o));return n},r.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return r.d(e,"a",e),e},r.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},r.p="",r(r.s=5)}([function(t,e,r){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.prepareCollection=e.extract=void 0;var n=function(t){return t&&t.__esModule?t:{default:t}}(r(1));function o(t,e,r){var o=e.value;return e.isDIObj&&(o=function(t,e){var r=e.split("."),n=t,o=!0,u=!1,i=void 0;try{for(var a,f=r[Symbol.iterator]();!(o=(a=f.next()).done);o=!0){var l=a.value;try{n=n[l]}catch(t){n=null;break}}}catch(t){u=!0,i=t}finally{try{!o&&f.return&&f.return()}finally{if(u)throw i}}return n}(t,o)),e.mutators.forEach(function(t){var u=void 0,i=void 0;e.isDIObj&&(r[e.value]=r[e.value]||{},u=r[e.value]),(i=n.default.list[t])&&"function"!=typeof i&&(i=i[n.default.prefix]),o=i?i(o,u):o}),o}e.extract=o,e.prepareCollection=function(t,e,r,n){var u=o(t,e.left,r),i=o(t,e.right,r);return{attribute:(null===u?e.left.value:u).replace(n,""),value:null===i?e.right.value:i,operator:e.operator,mutators:e.left.mutators}}},function(t,e,r){"use strict";function n(t,e,r){return e in t?Object.defineProperty(t,e,{value:r,enumerable:!0,configurable:!0,writable:!0}):t[e]=r,t}function o(t){return t instanceof Date?t:new Date(t)}Object.defineProperty(e,"__esModule",{value:!0});var u=Symbol(),i=Symbol(),a={radius:n({},i,function(t,e,r){return t.leftIsData?e.radius=t.leftValue:e.radius=t.rightValue,!0}),inArea:n({},i,function(t,e,r){function n(t){return t*(Math.PI/180)}var o=function(t,e,r,o){var u=n(r-t),i=n(o-e),a=Math.sin(u/2)*Math.sin(u/2)+Math.cos(n(t))*Math.cos(n(r))*Math.sin(i/2)*Math.sin(i/2);return 2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a))*6371}(t.rightValue[0],t.rightValue[1],t.leftValue[0],t.leftValue[1]);return e.radius>=o}),or:n({},i,function(t,e,r){if(e.container=e.container||{},e.container[r]=t.result,t.result)for(var n in e.container)e.container[n]=!0;return e.container}),toInt:function(t){return parseInt(t,10)},toString:function(t){return t+""},trim:function(t){return t.trim()},uppercase:function(t){return t.toUpperCase()},lowercase:function(t){return t.toLowerCase()},minute:function(t){return o(t).getMinutes()},day:function(t){return o(t).getDate()},hour:function(t){return o(t).getHours()},weekday:function(t){return o(t).getDay()},month:function(t){return o(t).getMonth()},year:function(t){return o(t).getFullYear()},regExp:function(t){var e=t.lastIndexOf("/"),r=t.substring(0,e),n=t.substring(e+1,t.length);return n&&n.length?new RegExp(r,n):new RegExp(r)}};var f={prefix:u,postfix:i,register:function(t,e,r){var o;a[t]=(n(o={},u,e),n(o,i,r),o)},unregister:function(t){delete a[t]},get list(){return a}};e.default=f},function(t,e,r){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var n={MongoJSONb:function(t){var e={"=":"$eq","==":"$eq","!=":"$ne",">=":"$gte",">":"$gt","<=":"$lte","<":"$lt","~=":"$in","^=":"$nin"},r={or:function(t,e,r){e[t.attribute]=e[t.attribute]||{$or:[]},e[t.attribute].$or.push(t.value)},radius:function(t,e,r){r.radius=t.value},inArea:function(t,e,r){e[t.attribute]={$near:{$geometry:{type:"Point",coordinates:t.value},$maxDistance:1e3*r.radius}}}},n={},o={},u=void 0;return t.forEach(function(t){u=t.attribute,t.mutators.length?t.mutators.forEach(function(e){r[e]&&(o[t.attribute]=o[t.attribute]||{},r[e](t,n,o[t.attribute]))}):n[u]?n[u][e[t.operator]]=t.value:"="===t.operator?n[u]=t.value:n[u]=function(t,e,r){return e in t?Object.defineProperty(t,e,{value:r,enumerable:!0,configurable:!0,writable:!0}):t[e]=r,t}({},e[t.operator],t.value)}),n}};e.default=n},function(t,e,r){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var n={"==":{"*":function(t,e){return t===e}},"!=":{"*":function(t,e){return t!==e}},">=":{"*":function(t,e){return t>=e},reverse:"<="},"<=":{"*":function(t,e){return t<=e},reverse:">="},"~=":{"*":function(t,e){return!!Array.isArray(e)&&e.includes(t)},reverse:"~!"},"~!":{"*":function(t,e){return!!Array.isArray(t)&&t.includes(e)},reverse:"~="},"^=":{"*":function(t,e){return!!Array.isArray(e)&&!e.includes(t)},reverse:"^!"},"^!":{"*":function(t,e){return!!Array.isArray(t)&&!t.includes(e)},reverse:"^="},"?=":{"*":function(t,e){return!t||t===e},reverse:"?!"},"?!":{"*":function(t,e){return!e||e===t},reverse:"?="},"=":{"*":function(t,e){return t===e}},">":{"*":function(t,e){return t>e},reverse:"<"},"<":{"*":function(t,e){return t<e},reverse:">"}};var o={register:function(t){var e=t.name,r=t.namespace,o=t.implement,u=t.reverse;n[e]=n[e]||{},n[e][r]=o,"*"===r&&u&&(n[e][r].reverse=u);var i={};Object.entries(n).sort(function(t,e){return t[0].length<e[0].length?1:t[0].length>e[0].length?-1:0}).forEach(function(t){i[t[0]]=t[1]}),n=i},unregister:function(t){var e=t.name,r=t.namespace,o=n[e];delete o[r],0===Object.keys(o).length&&delete n[e]},get list(){return n}};e.default=o},function(t,e,r){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.Mutator=e.Operator=e.executeExp=e.parseExp=void 0;var n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},o=a(r(3)),u=a(r(1)),i=r(0);function a(t){return t&&t.__esModule?t:{default:t}}var f=/^[a-zA-Z]+\.[a-zA-Z]+(?:\.\.[a-zA-Z]+)*/,l=/[^\n]+/,c="'";function s(t){var e=t.split(".."),r=e.slice(1,e.length),n=function(t){return t.includes(".")&&(0===t.indexOf("user.")||0===t.indexOf("env.")||0===t.indexOf("action.")||0===t.indexOf("resource."))}(e[0]),o=void 0;try{o=n?e[0]:JSON.parse(function(t){return t[0]===c&&t[t.length-1]===c&&(t='"'+t.substr(1,t.length-2)+'"'),t}(e[0]))}catch(t){var u="Parsing Error: \n\t unknown object - "+e[0]+" in expression";throw new Error(u)}return{isDIObj:n,value:o,mutators:r}}function v(t,e,r,o){t.mutators.forEach(function(i){var a=u.default.list[i];t.isDIObj&&"object"===(void 0===a?"undefined":n(a))&&a[u.default.postfix]&&(e.result=a[u.default.postfix](e,r[t.value],o))})}e.parseExp=function(t){var e=o.default.list,r=void 0,n=void 0;for(r in e)if(2===(n=t.split(r)).length)break;return 2===n.length&&f.test(n[0])&&l.test(n[1])||function(t){throw new Error("Semantic Error in "+t+": \n    Expression should be obj.attr[..mutator](operator)value or object.attribute\n    (user.role~=['admin','user'] , resource.location..radius=100)")}(t),{origin:t,left:s(n[0]),operator:r,right:s(n[1])}},e.executeExp=function(t,e,r,n){var u=o.default.list,a=(0,i.extract)(t,e.left,r),f=(0,i.extract)(t,e.right,r),l="*";e.left.isDIObj&&"function"==typeof u[e.operator][e.left.value]?l=e.left.value:e.right.isDIObj&&"function"==typeof u[e.operator][e.right.value]&&(l=e.right.value);var c=u[e.operator][l](a,f),s={leftIsData:!e.left.isDIObj,rightIsData:!e.right.isDIObj,leftValue:a,rightValue:f,result:c};return v(e.left,s,r,n),v(e.right,s,r,n),s.result},e.Operator=o.default,e.Mutator=u.default},function(t,e,r){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.Adapter=e.Mutator=e.Operator=e.Policy=void 0;var n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},o=function(){function t(t,e){for(var r=0;r<e.length;r++){var n=e[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}return function(e,r,n){return r&&t(e.prototype,r),n&&t(e,n),e}}(),u=r(4),i=r(0),a=function(t){return t&&t.__esModule?t:{default:t}}(r(2));var f=Symbol(),l="user.",c="resource.",s="condition",v="watcher",p="deny";function d(t,e){return t.isDIObj&&t.value.indexOf&&0===t.value.indexOf(e)}function y(t,e,r,n){var o={},u=[];return t[f][r].forEach(function(t){u.push((0,i.prepareCollection)(e,t,o,n))}),t.adapter(u)}function b(t,e,r,n,o){var i=u.Operator.list,a=JSON.parse(JSON.stringify(e)),l=void 0;d(a.left,n)?t[f][r].push(a):d(a.right,n)?(l=a.right,a.right=a.left,a.left=l,i[a.operator].reverse&&(a.operator=i[a.operator].reverse),t[f][r].push(a)):o&&o(a)}var h=function(){function t(e){var r=this;!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.adapter=a.default.MongoJSONb,this[f]={effect:e.effect!==p,target:[],condition:[],watcher:[],lastData:null},e.target.map(function(t){return(0,u.parseExp)(t)}).forEach(function(t){b(r,t,v,l),b(r,t,s,c,function(t){r[f].target.push(t)})})}return o(t,[{key:"check",value:function(t){var e={},r={},o=void 0,i=void 0,a=!0,l=!0,c=!1,s=void 0;try{for(var v,p=this[f].target[Symbol.iterator]();!(l=(v=p.next()).done);l=!0){var d=v.value;o=Math.floor(65536*(1+Math.random())).toString(16).substring(1),"boolean"===(void 0===(i=(0,u.executeExp)(t,d,e,o))?"undefined":n(i))?r[o]=i:Object.assign(r,i)}}catch(t){c=!0,s=t}finally{try{!l&&p.return&&p.return()}finally{if(c)throw s}}return Object.values(r).forEach(function(t){a=a&&t}),a=this[f].effect?a:!a,this[f].lastData=a?t:void 0,a}},{key:"setAdapter",value:function(t){this.adapter=t}},{key:"getConditions",value:function(){if(void 0!==this[f].lastData)return y(this,this[f].lastData,s,c)}},{key:"getWatchers",value:function(t){return y(this,t,v,l)}}]),t}();e.Policy=h,e.Operator=u.Operator,e.Mutator=u.Mutator,e.Adapter=a.default}]);