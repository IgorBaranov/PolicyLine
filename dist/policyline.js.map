{"version":3,"sources":["webpack://policyline/webpack/bootstrap","webpack://policyline/(webpack)/buildin/global.js","webpack://policyline/./src/condition.js","webpack://policyline/./src/di.js","webpack://policyline/./src/expression.js","webpack://policyline/./src/external/array.js","webpack://policyline/./src/external/index.js","webpack://policyline/./src/external/string.js","webpack://policyline/./src/external/time.js","webpack://policyline/./src/index.js","webpack://policyline/./src/target.js","webpack://policyline/./src/utils.js","webpack://policyline/external {\"commonjs\":\"moment\",\"commonjs2\":\"moment\"}"],"names":["g","Function","eval","e","window","module","exports","compileCondition","condition","conditionReg","conditionArray","exec","slice","replace","createCondition","expr","wrap","namespace","container","value","key","substring","indexOf","name","includes","length","wrapNamespaces","obj","prepareCondition","conditions","result","tmp","rule","undefined","Array","isArray","flag","push","calculateCondition","target","source","data","user","action","env","resource","item","DI","register","fn","global","unregister","clear","loadPresets","fileName","fnName","operators","TYPE","op","val","wrapToToken","type","createTokens","expression","array","split","map","infixToRPN","tokens","queue","stack","precedence","token","shift","tkPrec","stPrec","pop","fillTokens","res","evaluateRPN","rhs","lhs","concat","$in","String","Time","$trim","str","trim","$uppercase","toUpperCase","$lowercase","toLowerCase","$strToInt","parseInt","$timeBetween","time","start","end","currentTime","startTime","endTime","hour","isBefore","add","isBetween","$moment","date","pattern","unix","$day","param","day","$week","week","Math","ceil","$month","month","$quarter","quarter","$year","year","$dataToTimestamp","format","property","Symbol","calcResult","Policy","origin","_expression","_targets","_conditions","policies","algorithm","effect","uniqID","random","toString","substr","operation","Object","assign","_groupConstructor","_singleConstructor","_mergeConstructor","error","entries","forEach","policy","settings","log","compileTarget","ruleReg","ruleArray","join","di","compilePolicy","rules","deny","ruleResult","console","isObject","RegExp","mergeDeep"],"mappings":";;AAAA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;;;AAGA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA,kDAA0C,gCAAgC;AAC1E;AACA;;AAEA;AACA;AACA;AACA,gEAAwD,kBAAkB;AAC1E;AACA,yDAAiD,cAAc;AAC/D;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,iDAAyC,iCAAiC;AAC1E,wHAAgH,mBAAmB,EAAE;AACrI;AACA;;AAEA;AACA;AACA;AACA,mCAA2B,0BAA0B,EAAE;AACvD,yCAAiC,eAAe;AAChD;AACA;AACA;;AAEA;AACA,8DAAsD,+DAA+D;;AAErH;AACA;;;AAGA;AACA;;;;;;;;;;;;;;;;;AClFA,IAAIA,CAAJ;;AAEA;AACAA,IAAK,YAAW;AACf,QAAO,IAAP;AACA,CAFG,EAAJ;;AAIA,IAAI;AACH;AACAA,KAAIA,KAAKC,SAAS,aAAT,GAAL,IAAkC,CAAC,GAAGC,IAAJ,EAAU,MAAV,CAAtC;AACA,CAHD,CAGE,OAAOC,CAAP,EAAU;AACX;AACA,KAAI,QAAOC,MAAP,yCAAOA,MAAP,OAAkB,QAAtB,EAAgCJ,IAAII,MAAJ;AAChC;;AAED;AACA;AACA;;AAEAC,OAAOC,OAAP,GAAiBN,CAAjB,C;;;;;;;;;;;;;;;;;ACnBA,SAASO,gBAAT,CAA0BC,SAA1B,EAAqC;AACjC,QAAIC,eAAe,wCAAnB,CADiC,CAC4B;AAC7D,QAAIC,iBAAiBD,aAAaE,IAAb,CAAkBH,SAAlB,EAA6BI,KAA7B,CAAmC,CAAnC,EAAsC,CAAtC,CAArB;;AAEAF,mBAAe,CAAf,IAAoBA,eAAe,CAAf,EAAkBG,OAAlB,CAA0B,WAA1B,EAAuC,EAAvC,CAApB;AACA,WAAOH,cAAP;AACH;;AAED,SAASI,eAAT,CAAyBC,IAAzB,EAA+B;AAC3B,WAAO,IAAId,QAAJ,CAAa,MAAb,EAAqB,QAArB,EAA+B,KAA/B,EAAsC,UAAtC,EAAkD,YAAYc,IAAZ,GAAmB,GAArE,CAAP;AACH;;AAED,SAASC,IAAT,CAAcC,SAAd,EAAyBC,SAAzB,EAAoCC,KAApC,EAA2C;AACvC,QAAIC,MAAMH,UAAUI,SAAV,CAAoB,CAApB,EAAuBJ,UAAUK,OAAV,CAAkB,GAAlB,CAAvB,CAAV;AACA,QAAIC,OAAON,UAAUI,SAAV,CAAoBJ,UAAUK,OAAV,CAAkB,GAAlB,IAAyB,CAA7C,CAAX;;AAEA,QAAIL,UAAUK,OAAV,CAAkB,IAAlB,MAA4B,CAA5B,IAAiCL,UAAUK,OAAV,CAAkB,GAAlB,MAA2B,CAAhE,EAAmE;AAC/DF,cAAM,EAAN;AACAG,eAAON,UAAUJ,OAAV,CAAkB,SAAlB,EAA6B,EAA7B,CAAP;AACH;;AAED,QAAIU,QAAQA,KAAKC,QAAL,CAAc,GAAd,CAAR,IAA8BJ,IAAIK,MAAtC,EAA8C;AAC1C,YAAI,CAACP,UAAUE,GAAV,CAAL,EACIF,UAAUE,GAAV,IAAiB,EAAjB;AACJJ,aAAKO,IAAL,EAAWL,UAAUE,GAAV,CAAX,EAA2BD,KAA3B;AACH,KAJD,MAIO,IAAIC,IAAIK,MAAR,EAAgB;AACnB,YAAI,CAACP,UAAUE,GAAV,CAAL,EACIF,UAAUE,GAAV,IAAiB,EAAjB;AACJF,kBAAUE,GAAV,EAAeG,IAAf,IAAuBJ,KAAvB;AACH,KAJM,MAIA;AACHD,kBAAUK,IAAV,IAAkBJ,KAAlB;AACH;;AAED,WAAOD,SAAP;AACH;;AAED,SAASQ,cAAT,CAAwBC,GAAxB,EAA6B;AACzB,SAAK,IAAIP,GAAT,IAAgBO,GAAhB,EAAqB;AACjB,YAAIP,IAAII,QAAJ,CAAa,GAAb,CAAJ,EAAuB;AACnBR,iBAAKI,GAAL,EAAUO,GAAV,EAAeA,IAAIP,GAAJ,CAAf;AACA,mBAAOO,IAAIP,GAAJ,CAAP;AACH;AACJ;;AAED,WAAOO,GAAP;AACH;;AAED,SAASC,gBAAT,CAA0BC,UAA1B,EAAsC;AAClC,QAAIC,SAAS,EAAb;AADkC;AAAA;AAAA;;AAAA;AAElC,6BAAsBD,UAAtB,8HAAkC;AAAA,gBAAzBrB,SAAyB;;AAC9B,gBAAIuB,YAAJ;AAAA,gBAASC,OAAOzB,iBAAiBC,SAAjB,CAAhB;AACA,gBAAIwB,KAAK,CAAL,MAAY,GAAZ,IAAmBA,KAAK,CAAL,MAAY,IAAnC,EAAyC;AACrCD,sBAAMjB,gBAAgBkB,KAAK,CAAL,CAAhB,CAAN;AACH,aAFD,MAEO;AACHD,sBAAM,CAACC,KAAK,CAAL,CAAD,EAAUlB,gBAAgBkB,KAAK,CAAL,CAAhB,CAAV,CAAN;AACH;;AAED,gBAAIF,OAAOE,KAAK,CAAL,CAAP,MAAoBC,SAAxB,EAAmC;AAC/BH,uBAAOE,KAAK,CAAL,CAAP,IAAkBD,GAAlB;AACH,aAFD,MAEO;AACH,oBAAI,CAACG,MAAMC,OAAN,CAAcL,OAAOE,KAAK,CAAL,CAAP,CAAd,CAAL,EAAqC;AACjCF,2BAAOE,KAAK,CAAL,CAAP,IAAkB,CAACF,OAAOE,KAAK,CAAL,CAAP,CAAD,CAAlB;AACAF,2BAAOE,KAAK,CAAL,CAAP,EAAgBI,IAAhB,GAAuB,IAAvB,CAFiC,CAEJ;AAChC;AACDN,uBAAOE,KAAK,CAAL,CAAP,EAAgBK,IAAhB,CAAqBN,GAArB;AACH;AACJ;AAnBiC;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;AAoBlC,WAAOL,eAAeI,MAAf,CAAP;AACH;;AAED,SAASQ,kBAAT,CAA4BC,MAA5B,EAAoCC,MAApC,EAA4CC,IAA5C,EAAkD;AAC9C,SAAK,IAAIrB,GAAT,IAAgBoB,MAAhB,EAAwB;AACpB,YAAIN,MAAMC,OAAN,CAAcK,OAAOpB,GAAP,CAAd,KAA8B,CAACoB,OAAOpB,GAAP,EAAYgB,IAA/C,EAAqD;AACjDG,mBAAOnB,GAAP,IAAc,CAACoB,OAAOpB,GAAP,EAAY,CAAZ,CAAD,CAAd;AACAmB,mBAAOnB,GAAP,EAAYiB,IAAZ,CAAiBG,OAAOpB,GAAP,EAAY,CAAZ,EAAeqB,KAAKC,IAApB,EAA0BD,KAAKE,MAA/B,EAAuCF,KAAKG,GAA5C,EAAiDH,KAAKI,QAAtD,CAAjB;AACH,SAHD,MAGO,IAAI,OAAOL,OAAOpB,GAAP,CAAP,KAAuB,UAA3B,EAAuC;AAC1CmB,mBAAOnB,GAAP,IAAcoB,OAAOpB,GAAP,EAAYqB,KAAKC,IAAjB,EAAuBD,KAAKE,MAA5B,EAAoCF,KAAKG,GAAzC,EAA8CH,KAAKI,QAAnD,CAAd;AACH,SAFM,MAEA,IAAIX,MAAMC,OAAN,CAAcK,OAAOpB,GAAP,CAAd,CAAJ,EAAgC;AACnCmB,mBAAOnB,GAAP,IAAc,EAAd;AACA,gBAAIU,eAAJ;AAFmC;AAAA;AAAA;;AAAA;AAGnC,sCAAiBU,OAAOpB,GAAP,CAAjB,mIAA8B;AAAA,wBAArB0B,IAAqB;;AAC1BhB,6BAASgB,KAAKL,KAAKC,IAAV,EAAgBD,KAAKE,MAArB,EAA6BF,KAAKG,GAAlC,EAAuCH,KAAKI,QAA5C,CAAT;AACA,wBAAIf,WAAW,IAAX,IAAmBA,WAAWG,SAAlC,EAA6C;AACzCM,+BAAOnB,GAAP,EAAYiB,IAAZ,CAAiBP,MAAjB;AACH;AACJ;AARkC;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAStC,SATM,MASA;AACHS,mBAAOnB,GAAP,IAAc,EAAd;AACAkB,+BAAmBC,OAAOnB,GAAP,CAAnB,EAAgCoB,OAAOpB,GAAP,CAAhC,EAA6CqB,IAA7C;AACH;AACJ;AACD,WAAOF,MAAP;AACH;;QAGGX,gB,GAAAA,gB;QACAU,kB,GAAAA,kB;;;;;;;;;;;;;;;;;;;AChGJ;;;;;;AAEA,IAAMrB,YAAY,eAAlB;;AAEA,IAAM8B,KAAK;AACPC,YADO,oBACEzB,IADF,EACQ0B,EADR,EACY;AACfC,eAAOjC,SAAP,IAAoBiC,OAAOjC,SAAP,KAAqB,EAAzC;;AAEA,YAAI,OAAOM,IAAP,KAAgB,UAApB,EAAgC;AAC5B2B,mBAAOjC,SAAP,EAAkBM,KAAKA,IAAvB,IAA+BA,IAA/B;AACH,SAFD,MAEO;AACH2B,mBAAOjC,SAAP,EAAkBM,IAAlB,IAA0B0B,EAA1B;AACH;AACJ,KATM;AAWPE,cAXO,sBAWI5B,IAXJ,EAWU;AACb,YAAI2B,OAAOjC,SAAP,MAAsBgB,SAA1B,EAAqC;AACjC;AACH;;AAED,eAAOiB,OAAOjC,SAAP,EAAmB,OAAOM,IAAP,KAAgB,UAAjB,GAA+BA,KAAKA,IAApC,GAA2CA,IAA7D,CAAP;AACH,KAjBM;AAmBP6B,SAnBO,mBAmBC;AACJ,eAAOF,OAAOjC,SAAP,CAAP;AACH,KArBM;AAuBPoC,eAvBO,yBAuBO;AACV,aAAK,IAAMC,QAAX,wBAA8B;AAC1B,iBAAK,IAAMC,MAAX,IAAqB,mBAAMD,QAAN,CAArB,EAAsC;AAClCP,mBAAGC,QAAH,CAAYO,MAAZ,EAAoB,mBAAMD,QAAN,EAAgBC,MAAhB,CAApB;AACH;AACJ;AACJ;AA7BM,CAAX;;QAiCIR,E,GAAAA,E;QACA9B,S,GAAAA,S;;;;;;;;;;;;;;;;;;ACtCJ;AACA,IAAMuC,YAAY,CAAC,KAAD,EAAQ,IAAR,EAAc,GAAd,EAAmB,GAAnB,CAAlB;AACA,IAAMC,OAAO;AACTC,QAAI,IADK;AAETC,SAAK;AAFI,CAAb;;AAKA,SAASC,WAAT,CAAqBd,IAArB,EAA2B;AACvB,WAAO;AACHa,aAAKb,IADF;AAEHe,cAAML,UAAUhC,QAAV,CAAmBsB,IAAnB,IAA2BW,KAAKC,EAAhC,GAAqCD,KAAKE;AAF7C,KAAP;AAIH;;AAED,SAASG,YAAT,CAAsBC,UAAtB,EAAkC;AAC9B,QAAMC,QAAQD,WAAWE,KAAX,CAAiB,kBAAjB,CAAd;AACA,WAAOD,MAAME,GAAN,CAAUN,WAAV,CAAP;AACH;;AAED,SAASO,UAAT,CAAoBC,MAApB,EAA4B;AACxB,QAAMC,QAAQ,EAAd;AACA,QAAMC,QAAQ,EAAd;AACA,QAAMC,aAAa;AACf,aAAK,EADU;AAEf,eAAO,EAFQ;AAGf,cAAM;AAHS,KAAnB;;AAMA,WAAOH,OAAO3C,MAAd,EAAsB;AAClB,YAAM+C,QAAQJ,OAAOK,KAAP,EAAd;AACA,YAAMC,SAASH,WAAWC,MAAMb,GAAjB,KAAyB,CAAxC;AACA,YAAIgB,SAASL,MAAM7C,MAAN,GAAe8C,WAAWD,MAAMA,MAAM7C,MAAN,GAAe,CAArB,EAAwBkC,GAAnC,CAAf,GAAyD,CAAtE;;AAEA,YAAIa,MAAMX,IAAN,KAAeJ,KAAKC,EAApB,IAA0Bc,MAAMb,GAAN,KAAc,GAA5C,EAAiD;AAC7C,gBAAID,KAAK,IAAT;;AAEA,mBAAO,CAACA,KAAKY,MAAMM,GAAN,EAAN,EAAmBjB,GAAnB,KAA2B,GAAlC,EAAuC;AACnCU,sBAAMhC,IAAN,CAAWqB,EAAX;AACH;AACJ,SAND,MAMO,IAAIc,MAAMX,IAAN,KAAeJ,KAAKE,GAAxB,EAA6B;AAChCU,kBAAMhC,IAAN,CAAWmC,KAAX;AACH,SAFM,MAEA,IAAIA,MAAMX,IAAN,KAAeJ,KAAKC,EAApB,KAA2B,CAACY,MAAM7C,MAAP,IAAiB+C,MAAMb,GAAN,KAAc,GAA/B,IAAsCe,SAASC,MAA1E,CAAJ,EAAuF;AAC1FL,kBAAMjC,IAAN,CAAWmC,KAAX;AACH,SAFM,MAEA;AACH,mBAAOE,UAAUC,MAAjB,EAAyB;AACrBN,sBAAMhC,IAAN,CAAWiC,MAAMM,GAAN,EAAX;AACAD,yBAASL,MAAM7C,MAAN,GAAe8C,WAAWD,MAAMA,MAAM7C,MAAN,GAAe,CAArB,EAAwBkC,GAAnC,CAAf,GAAyD,CAAlE;AACH;;AAEDW,kBAAMjC,IAAN,CAAWmC,KAAX;AACH;AACJ;;AAED,WAAOF,MAAM7C,MAAb,EAAqB;AACjB4C,cAAMhC,IAAN,CAAWiC,MAAMM,GAAN,EAAX;AACH;;AAED,WAAOP,KAAP;AACH;;AAED,SAASQ,UAAT,CAAoBT,MAApB,EAA4B3B,IAA5B,EAAkC;AAC9B,WAAO2B,OAAOF,GAAP,CAAW,UAACpB,IAAD,EAAU;AACxB,YAAIA,KAAKe,IAAL,KAAcJ,KAAKE,GAAvB,EAA4B;AACxBb,iBAAKgC,GAAL,GAAWrC,KAAKK,KAAKa,GAAV,CAAX;AACAb,iBAAKa,GAAL,GAAW,CAACb,KAAKa,GAAN,CAAX;AACH;AACD,eAAOb,IAAP;AACH,KANM,CAAP;AAOH;;AAED,SAASiC,WAAT,CAAqBX,MAArB,EAA6B;AACzB,QAAME,QAAQ,EAAd;AACA,QAAIX,YAAJ;;AAEA,WAAOS,OAAO3C,MAAd,EAAsB;AAClB,YAAM+C,QAAQJ,OAAOK,KAAP,EAAd;;AAEA,YAAID,MAAMX,IAAN,KAAeJ,KAAKE,GAAxB,EAA6B;AACzBW,kBAAMjC,IAAN,CAAWmC,KAAX;AACA;AACH;;AAED,YAAMQ,MAAMV,MAAMM,GAAN,EAAZ;AACA,YAAMK,MAAMX,MAAMM,GAAN,EAAZ;;AAEA,gBAAQJ,MAAMb,GAAd;AACI,iBAAK,KAAL;AACIW,sBAAMjC,IAAN,CAAW;AACPwB,0BAAMJ,KAAKE,GADJ;AAEPA,yBAAMqB,IAAIF,GAAJ,IAAWG,IAAIH,GAAhB,GAAuBG,IAAItB,GAAJ,CAAQuB,MAAR,CAAeF,IAAIrB,GAAnB,CAAvB,GAAiD,EAF/C;AAGPmB,yBAAKE,IAAIF,GAAJ,IAAWG,IAAIH;AAHb,iBAAX;AAKA;AACJ,iBAAK,IAAL;AACInB,sBAAM,EAAN;AACA,oBAAIsB,IAAIH,GAAR,EAAa;AACTnB,0BAAMsB,IAAItB,GAAV;AACH,iBAFD,MAEO,IAAIqB,IAAIF,GAAR,EAAa;AAChBnB,0BAAMqB,IAAIrB,GAAV;AACH;;AAEDW,sBAAMjC,IAAN,CAAW;AACPwB,0BAAMJ,KAAKE,GADJ;AAEPA,yBAAKA,GAFE;AAGPmB,yBAAKE,IAAIF,GAAJ,IAAWG,IAAIH;AAHb,iBAAX;AAKA;AArBR;AAuBH;;AAED,WAAOR,MAAMM,GAAN,EAAP;AACH;;QAGGd,Y,GAAAA,Y;QACAK,U,GAAAA,U;QACAU,U,GAAAA,U;QACAE,W,GAAAA,W;QACAnB,W,GAAAA,W;;;;;;;;;;;;;;;;;kBCtHW;AACXuB,SAAK,aAAUnB,KAAV,EAAiB7C,KAAjB,EAAwB;AACzB,eAAO6C,MAAMxC,QAAN,CAAeL,KAAf,CAAP;AACH;AAHU,C;;;;;;;;;;;;;;;;;;ACAf;;;;AACA;;;;AACA;;;;;;kBAEe;AACXiE,4BADW;AAEXlD,0BAFW;AAGXmD;AAHW,C;;;;;;;;;;;;;;;;;kBCJA;AACXC,WAAO,eAASC,GAAT,EAAc;AACjB,eAAOA,IAAIC,IAAJ,EAAP;AACH,KAHU;;AAKXC,gBAAY,oBAAUF,GAAV,EAAe;AACvB,eAAOA,IAAIG,WAAJ,EAAP;AACH,KAPU;;AASXC,gBAAY,oBAAUJ,GAAV,EAAe;AACvB,eAAOA,IAAIK,WAAJ,EAAP;AACH,KAXU;;AAaXC,eAAW,mBAAUN,GAAV,EAAe;AACtB,eAAOO,SAASP,GAAT,EAAc,EAAd,CAAP;AACH;AAfU,C;;;;;;;;;;;;;;;;;;ACAf;;;;;;kBAEe;AACX;AACAQ,gBAFW,wBAEEC,IAFF,EAEQC,KAFR,EAEeC,GAFf,EAEoB;AAC3B,YAAIC,cAAc,sBAAOH,IAAP,EAAa,SAAb,CAAlB;AACA,YAAII,YAAY,sBAAOH,KAAP,EAAc,SAAd,CAAhB;AACA,YAAII,UAAU,sBAAOH,GAAP,EAAY,SAAZ,CAAd;;AAEA,YAAKE,UAAUE,IAAV,MAAoB,EAApB,IAA0BD,QAAQC,IAAR,MAAkB,EAA7C,IAAoDD,QAAQE,QAAR,CAAiBH,SAAjB,CAAxD,EAAqF;AACjFC,oBAAQG,GAAR,CAAY,CAAZ,EAAe,MAAf,EADiF,CACzD;;AAExB,gBAAIL,YAAYG,IAAZ,MAAsB,EAA1B,EAA8B;AAC1BH,4BAAYK,GAAZ,CAAgB,CAAhB,EAAmB,MAAnB,EAD0B,CACE;AAC/B;AACJ;;AAED,eAAOL,YAAYM,SAAZ,CAAsBL,SAAtB,EAAiCC,OAAjC,CAAP;AACH,KAhBU;;;AAkBX;AACAK,WAnBW,mBAmBHC,IAnBG,EAmBGC,OAnBH,EAmBY;AACnB,YAAIA,YAAY,MAAhB,EAAwB;AACpB,mBAAO,iBAAOC,IAAP,CAAYF,IAAZ,CAAP;AACH;AACD,eAAO,sBAAOA,IAAP,EAAaC,OAAb,CAAP;AACH,KAxBU;;;AA0BX;AACAE,QA3BW,gBA2BNnD,GA3BM,EA2BgB;AAAA,YAAjBoD,KAAiB,uEAAT,OAAS;;AACvB,YAAIC,MAAM,iBAAOH,IAAP,CAAYlD,GAAZ,CAAV;AACA,gBAAQoD,KAAR;AACI,iBAAK,MAAL;AACIC,sBAAMA,IAAIA,GAAJ,EAAN;AACA;AACJ;AACIA,sBAAMA,IAAIL,IAAJ,EAAN;AALR;AAOA,eAAOK,GAAP;AACH,KArCU;;;AAuCX;AACAC,SAxCW,iBAwCLtD,GAxCK,EAwCiB;AAAA,YAAjBoD,KAAiB,uEAAT,OAAS;;AACxB,YAAIG,OAAO,iBAAOL,IAAP,CAAYlD,GAAZ,CAAX;AACA,YAAIoD,UAAU,MAAd,EAAsB;AAClB;AACAG,mBAAOA,KAAKA,IAAL,EAAP;AACH,SAHD,MAGO;AACHA,mBAAOC,KAAKC,IAAL,CAAUF,KAAKP,IAAL,KAAc,CAAxB,CAAP;AACH;;AAED,eAAOO,IAAP;AACH,KAlDU;;;AAoDX;AACAG,UArDW,kBAqDJ1D,GArDI,EAqDC;AACR,eAAO,iBAAOkD,IAAP,CAAYlD,GAAZ,EAAiB2D,KAAjB,EAAP;AACH,KAvDU;;;AAyDX;AACAC,YA1DW,oBA0DF5D,GA1DE,EA0DG;AACV,eAAO,iBAAOkD,IAAP,CAAYlD,GAAZ,EAAiB6D,OAAjB,EAAP;AACH,KA5DU;;;AA8DX;AACAC,SA/DW,iBA+DL9D,GA/DK,EA+DA;AACP,eAAO,iBAAOkD,IAAP,CAAYlD,GAAZ,EAAiB+D,IAAjB,EAAP;AACH,KAjEU;;;AAmEX;AACAC,oBApEW,4BAoEMhE,GApEN,EAoEWiD,OApEX,EAoEoB;AAC3B,eAAOd,SAAS,sBAAOnC,GAAP,EAAYiD,OAAZ,EAAqBgB,MAArB,CAA4B,GAA5B,CAAT,EAA2C,EAA3C,CAAP;AACH;AAtEU,C;;;;;;;;;;;;;;;;;;;;;ACFf;;AACA;;AACA;;AAOA;;AACA;;;;;;AAEA,IAAIC,WAAWC,QAAf;AACA,IAAIC,aAAaD,QAAjB;;IAEME,M;;;0CACgBC,M,EAAQ;AACtB,iBAAKC,WAAL,GAAmB,4BAAW,8BAAaD,OAAOlE,UAApB,CAAX,CAAnB;;AAEA,iBAAKoE,QAAL,GAAgB,EAAhB;AACA,iBAAKC,WAAL,GAAmB,EAAnB;AACA,iBAAK,IAAMhH,GAAX,IAAkB6G,OAAOI,QAAzB,EAAmC;AAAA,2CACcJ,OAAOI,QAAP,CAAgBjH,GAAhB,CADd;AAAA,oBAC1BmB,MAD0B,wBAC1BA,MAD0B;AAAA,oBAClB+F,SADkB,wBAClBA,SADkB;AAAA,oBACPC,MADO,wBACPA,MADO;AAAA,oBACC/H,SADD,wBACCA,SADD;;AAE/B,qBAAK2H,QAAL,CAAc/G,GAAd,IAAqB,2BAAcmB,MAAd,EAAsB+F,SAAtB,EAAiCC,MAAjC,CAArB;AACA,qBAAKH,WAAL,CAAiBhH,GAAjB,IAAwB,iCAAiBZ,aAAa,EAA9B,CAAxB;AACH;AACJ;;;2CAEkB+B,M,EAAQ+F,S,EAAWC,M,EAAQ/H,S,EAAW;AACrD,gBAAIgI,SAASrB,KAAKsB,MAAL,GAAcC,QAAd,CAAuB,EAAvB,EAA2BC,MAA3B,CAAkC,CAAlC,EAAqC,CAArC,CAAb;;AAEA,iBAAKT,WAAL,GAAmB,CAAC,6BAAYM,MAAZ,CAAD,CAAnB;AACA,iBAAKL,QAAL,uBACKK,MADL,EACc,2BAAcjG,MAAd,EAAsB+F,SAAtB,EAAiCC,MAAjC,CADd;AAGA,iBAAKH,WAAL,uBACKI,MADL,EACc,iCAAiBhI,aAAa,EAA9B,CADd;AAGH;;;0CAEiByH,M,EAAQzF,M,EAAQoG,S,EAAW;AACzC,iBAAKV,WAAL,GAAmBD,OAAOC,WAAP,CAAmBhD,MAAnB,CAA0B1C,OAAO0F,WAAjC,EAA8C,6BAAYU,SAAZ,CAA9C,CAAnB;AACA,iBAAKT,QAAL,GAAgBU,OAAOC,MAAP,CAAc,EAAd,EAAkBb,OAAOE,QAAzB,EAAmC3F,OAAO2F,QAA1C,CAAhB;AACA,iBAAKC,WAAL,GAAmBS,OAAOC,MAAP,CAAc,EAAd,EAAkBb,OAAOG,WAAzB,EAAsC5F,OAAO4F,WAA7C,CAAnB;AACH;;;AAED,oBAAYH,MAAZ,EAAoBzF,MAApB,EAA4B+F,MAA5B,EAAoC;AAAA;;AAChC,YAAIN,OAAOI,QAAP,KAAoBpG,SAAxB,EAAmC;AAC/B,iBAAK8G,iBAAL,CAAuBd,MAAvB;AACH,SAFD,MAEO,IAAIzF,WAAWP,SAAX,IAAwBsG,WAAWtG,SAAvC,EAAkD;AACrD,iBAAK+G,kBAAL,CAAwBf,OAAO1F,MAA/B,EAAuC0F,OAAOK,SAA9C,EAAyDL,OAAOM,MAAhE,EAAwEN,OAAOzH,SAA/E;AACH,SAFM,MAEA;AACH,iBAAKyI,iBAAL,CAAuBhB,MAAvB,EAA+BzF,MAA/B,EAAuC+F,MAAvC;AACH;;AAED;AACA,aAAKV,QAAL,IAAiB,EAAjB;AACH;;;;8BAEKnF,I,EAAMC,M,EAAQC,G,EAAKC,Q,EAAU;AAC/B,gBAAIf,SAAS,EAAb;AACA,iBAAK,IAAMV,GAAX,IAAkB,KAAK+G,QAAvB,EAAiC;AAC7BrG,uBAAOV,GAAP,IAAc,KAAK+G,QAAL,CAAc/G,GAAd,EAAmBsB,IAAnB,EAAyBC,MAAzB,EAAiCC,GAAjC,EAAsCC,QAAtC,CAAd;AACH;;AAED;AACA,iBAAKgF,QAAL,IAAiB,EAACnF,UAAD,EAAOC,cAAP,EAAeC,QAAf,EAAoBC,kBAApB,EAAjB;AACA,iBAAKkF,UAAL,IAAmB,6BAAY,4BAAW,KAAKG,WAAhB,EAA6BpG,MAA7B,CAAZ,CAAnB;;AAEA,mBAAO,KAAKiG,UAAL,EAAiBjD,GAAxB;AACH;;;kCAESpC,I,EAAMC,M,EAAQC,G,EAAKC,Q,EAAU;AAAA;;AACnC,gBAAI,CAAC,KAAKkF,UAAL,EAAiBjD,GAAtB,EAA2B;AACvB;AACH;;AAED,gBAAIrC,OAAO;AACPC,sBAAM,sBAAUA,IAAV,EAAgB,KAAKmF,QAAL,EAAenF,IAA/B,CADC;AAEPC,wBAAQ,sBAAUA,MAAV,EAAkB,KAAKkF,QAAL,EAAelF,MAAjC,CAFD;AAGPC,qBAAK,sBAAUA,GAAV,EAAe,KAAKiF,QAAL,EAAejF,GAA9B,CAHE;AAIPC,0BAAU,sBAAUA,QAAV,EAAoB,KAAKgF,QAAL,EAAehF,QAAnC;AAJH,aAAX;AAMA,iBAAKgF,QAAL,IAAiB,EAAjB;;AAEA,gBAAI;AACA,oBAAIhG,aAAa,EAAjB;AAAA,oBAAqBrB,YAAY,EAAjC;AACA,qBAAK,IAAMY,GAAX,IAAkB,KAAKgH,WAAvB,EAAoC;AAChC,wBAAI;AACAvG,mCAAWT,GAAX,IAAkB,mCAAmB,EAAnB,EAAuB,KAAKgH,WAAL,CAAiBhH,GAAjB,CAAvB,EAA8CqB,IAA9C,CAAlB;AACH,qBAFD,CAEE,OAAOyG,KAAP,EAAc;AACZ;AACH;AACJ;;AAED,oBAAIlF,QAAQ6E,OAAOM,OAAP,CAAetH,UAAf,CAAZ;AACAmC,sBAAMoF,OAAN,CAAc,UAACtG,IAAD,EAAU;AACpB,wBAAI,MAAKiF,UAAL,EAAiBpE,GAAjB,CAAqBnC,QAArB,CAA8BsB,KAAK,CAAL,CAA9B,CAAJ,EAA4C;AACxC,8CAAUtC,SAAV,EAAqBsC,KAAK,CAAL,CAArB;AACH;AACJ,iBAJD;;AAMAL,qBAAKjC,SAAL,GAAiB,sBAAUA,SAAV,EAAqBiC,KAAKI,QAA1B,CAAjB;AACH,aAlBD,CAkBE,OAAO1C,CAAP,EAAU;AACRsC,uBAAOtC,CAAP;AACH;AACD,iBAAK4H,UAAL,IAAmB,EAAnB;;AAEA,mBAAOtF,IAAP;AACH;;;4BAEG4G,M,EAAQ;AACR,mBAAO,IAAIrB,MAAJ,CAAW,IAAX,EAAiBqB,MAAjB,EAAyB,KAAzB,CAAP;AACH;;;2BAEEA,M,EAAQ;AACP,mBAAO,IAAIrB,MAAJ,CAAW,IAAX,EAAiBqB,MAAjB,EAAyB,IAAzB,CAAP;AACH;;;;;;AAGL;;;AACA,OAAGhG,WAAH;;QAGI2E,M,GAAAA,M;QACAjF,E;QACAuG,Q;;;;;;;;;;;;;;;;;;;;;AC9HJ;;AAEA,IAAMA,WAAW;AACbC,SAAK;AADQ,CAAjB;;AAIA,SAASC,aAAT,CAAuBxH,IAAvB,EAA6B;AACzB,QAAIyH,UAAU,mCAAd;AACA,QAAI;AACA,YAAIC,YAAYD,QAAQ9I,IAAR,CAAaqB,IAAb,CAAhB;AACA,YAAI0H,SAAJ,EAAe;AACXA,wBAAYA,UAAU9I,KAAV,CAAgB,CAAhB,EAAmB,CAAnB,CAAZ;AACA,gBAAI8I,UAAU,CAAV,MAAiB,GAAjB,IAAwBA,UAAU,CAAV,MAAiB,IAA7C,EAAmD;AAC/CA,0BAAU,CAAV,IAAe,KAAf;AACH;AACD1H,mBAAO0H,UAAUC,IAAV,CAAe,EAAf,CAAP;AACH;;AAED;AACA,YAAIC,KAAK,EAAT;AACA,YAAI1G,0BAAsBjB,SAA1B,EAAqC;AACjC,iBAAK,IAAMb,GAAX,IAAkB8B,qBAAlB,EAAqC;AACjC,oBAAIlB,KAAKR,QAAL,CAAcJ,GAAd,CAAJ,EAAwB;AACpBwI,0BAAM,SAASxI,GAAT,GAAe,GAAf,mBAAiC,GAAjC,GAAuCA,GAAvC,GAA6C,GAAnD;AACH;AACJ;AACJ;;AAED;AACA,eAAO,IAAInB,QAAJ,CAAa,MAAb,EAAqB,QAArB,EAA+B,KAA/B,EAAsC,UAAtC,EACH,YAAY2J,EAAZ,GAAiB,YAAjB,GAAgC5H,IAAhC,GAAuC,gCADpC,CAAP;AAEH,KAvBD,CAuBE,OAAO7B,CAAP,EAAU;AACR,eAAO,IAAIF,QAAJ,CAAa,uCAAuC+B,IAAvC,GAA8C,KAA3D,CAAP;AACH;AACJ;;AAED,SAAS6H,aAAT,GAAwE;AAAA,QAAjDtH,MAAiD,uEAAxC,EAAwC;AAAA,QAApC+F,SAAoC,uEAAxB,KAAwB;AAAA,QAAjBC,MAAiB,uEAAR,MAAQ;;AACpE,QAAInG,OAAO,EAAEkG,cAAc,KAAhB,CAAX;AACA,QAAIwB,QAAQ,EAAZ;AACA,QAAIC,OAAOxB,WAAW,MAAtB;;AAEAhG,WAAO6G,OAAP,CAAe,UAACpH,IAAD,EAAU;AACrB8H,cAAMzH,IAAN,CAAWmH,cAAcxH,IAAd,CAAX;AACH,KAFD;;AAIA,WAAO,UAAUU,IAAV,EAAgBC,MAAhB,EAAwBC,GAAxB,EAA6BC,QAA7B,EAAuC;AAC1C,YAAIf,SAASM,IAAb;;AAD0C;AAAA;AAAA;;AAAA;AAG1C,iCAAiB0H,KAAjB,8HAAwB;AAAA,oBAAf9H,IAAe;;AACpB,oBAAIgI,aAAahI,KAAKU,IAAL,EAAWC,MAAX,EAAmBC,GAAnB,EAAwBC,QAAxB,CAAjB;;AAEA;AACA,oBAAI,QAAOmH,UAAP,yCAAOA,UAAP,OAAsB,QAA1B,EAAoC;AAChC,wBAAIV,SAASC,GAAb,EAAkB;AACdU,gCAAQf,KAAR,CAAcc,UAAd;AACH;AACD,2BAAO,KAAP;AACH;;AAED;AACAlI,yBAASM,OAAQN,UAAUkI,UAAlB,GAAiClI,UAAUkI,UAApD;AACH;AAhByC;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;AAkB1C,eAAOD,OAAO,CAACjI,MAAR,GAAiBA,MAAxB;AACH,KAnBD;AAoBH;;QAEO+H,a,GAAAA,a;QAAeP,Q,GAAAA,Q;;;;;;;;;;;;;;;;;;;;;ACnEvB,SAASY,QAAT,CAAkBpH,IAAlB,EAAwB;AACpB,WAAQA,QACD,QAAOA,IAAP,yCAAOA,IAAP,OAAgB,QADf,IAED,CAACZ,MAAMC,OAAN,CAAcW,IAAd,CAFA,IAGD,EAAEA,gBAAgBqH,MAAlB,CAHP;AAIH;;AAED,SAASC,SAAT,CAAmB7H,MAAnB,EAA2BC,MAA3B,EAAmC;AAC/B,QAAI0H,SAAS3H,MAAT,KAAoB2H,SAAS1H,MAAT,CAAxB,EAA0C;AACtC,aAAK,IAAMpB,GAAX,IAAkBoB,MAAlB,EAA0B;AACtB,gBAAI0H,SAAS1H,OAAOpB,GAAP,CAAT,CAAJ,EAA2B;AACvB,oBAAI,CAACmB,OAAOnB,GAAP,CAAL,EAAkB;AACdmB,2BAAOnB,GAAP,IAAc,EAAd;AACH;AACDgJ,0BAAU7H,OAAOnB,GAAP,CAAV,EAAuBoB,OAAOpB,GAAP,CAAvB;AACH,aALD,MAKO;AACHmB,uBAAOnB,GAAP,IAAcoB,OAAOpB,GAAP,CAAd;AACH;AACJ;AACJ;AACD,WAAOmB,UAAUC,MAAjB;AACH;;QAGG4H,S,GAAAA,S;;;;;;;;;;;ACxBJ,mC","file":"policyline.js","sourcesContent":[" \t// The module cache\n \tvar installedModules = {};\n\n \t// The require function\n \tfunction __webpack_require__(moduleId) {\n\n \t\t// Check if module is in cache\n \t\tif(installedModules[moduleId]) {\n \t\t\treturn installedModules[moduleId].exports;\n \t\t}\n \t\t// Create a new module (and put it into the cache)\n \t\tvar module = installedModules[moduleId] = {\n \t\t\ti: moduleId,\n \t\t\tl: false,\n \t\t\texports: {}\n \t\t};\n\n \t\t// Execute the module function\n \t\tmodules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n \t\t// Flag the module as loaded\n \t\tmodule.l = true;\n\n \t\t// Return the exports of the module\n \t\treturn module.exports;\n \t}\n\n\n \t// expose the modules object (__webpack_modules__)\n \t__webpack_require__.m = modules;\n\n \t// expose the module cache\n \t__webpack_require__.c = installedModules;\n\n \t// define getter function for harmony exports\n \t__webpack_require__.d = function(exports, name, getter) {\n \t\tif(!__webpack_require__.o(exports, name)) {\n \t\t\tObject.defineProperty(exports, name, { enumerable: true, get: getter });\n \t\t}\n \t};\n\n \t// define __esModule on exports\n \t__webpack_require__.r = function(exports) {\n \t\tif(typeof Symbol !== 'undefined' && Symbol.toStringTag) {\n \t\t\tObject.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });\n \t\t}\n \t\tObject.defineProperty(exports, '__esModule', { value: true });\n \t};\n\n \t// create a fake namespace object\n \t// mode & 1: value is a module id, require it\n \t// mode & 2: merge all properties of value into the ns\n \t// mode & 4: return value when already ns object\n \t// mode & 8|1: behave like require\n \t__webpack_require__.t = function(value, mode) {\n \t\tif(mode & 1) value = __webpack_require__(value);\n \t\tif(mode & 8) return value;\n \t\tif((mode & 4) && typeof value === 'object' && value && value.__esModule) return value;\n \t\tvar ns = Object.create(null);\n \t\t__webpack_require__.r(ns);\n \t\tObject.defineProperty(ns, 'default', { enumerable: true, value: value });\n \t\tif(mode & 2 && typeof value != 'string') for(var key in value) __webpack_require__.d(ns, key, function(key) { return value[key]; }.bind(null, key));\n \t\treturn ns;\n \t};\n\n \t// getDefaultExport function for compatibility with non-harmony modules\n \t__webpack_require__.n = function(module) {\n \t\tvar getter = module && module.__esModule ?\n \t\t\tfunction getDefault() { return module['default']; } :\n \t\t\tfunction getModuleExports() { return module; };\n \t\t__webpack_require__.d(getter, 'a', getter);\n \t\treturn getter;\n \t};\n\n \t// Object.prototype.hasOwnProperty.call\n \t__webpack_require__.o = function(object, property) { return Object.prototype.hasOwnProperty.call(object, property); };\n\n \t// __webpack_public_path__\n \t__webpack_require__.p = \"\";\n\n\n \t// Load entry module and return exports\n \treturn __webpack_require__(__webpack_require__.s = \"./src/index.js\");\n","var g;\n\n// This works in non-strict mode\ng = (function() {\n\treturn this;\n})();\n\ntry {\n\t// This works if eval is allowed (see CSP)\n\tg = g || Function(\"return this\")() || (1, eval)(\"this\");\n} catch (e) {\n\t// This works if the window reference is available\n\tif (typeof window === \"object\") g = window;\n}\n\n// g can still be undefined, but nothing to do about it...\n// We return undefined, instead of nothing here, so it's\n// easier to handle this case. if(!global) { ...}\n\nmodule.exports = g;\n","function compileCondition(condition) {\r\n    let conditionReg = /([\\w\\.\\'\\\"\\$]+)\\s?([<>=!]{1,2})\\s?(.+)/; // more stricter than 'target' regexp\r\n    let conditionArray = conditionReg.exec(condition).slice(1, 4);\r\n\r\n    conditionArray[0] = conditionArray[0].replace('resource.', '');\r\n    return conditionArray;\r\n}\r\n\r\nfunction createCondition(expr) {\r\n    return new Function('user', 'action', 'env', 'resource', 'return ' + expr + ';');\r\n}\r\n\r\nfunction wrap(namespace, container, value) {\r\n    let key = namespace.substring(0, namespace.indexOf('.'));\r\n    let name = namespace.substring(namespace.indexOf('.') + 1);\r\n\r\n    if (namespace.indexOf('\\'') === 0 || namespace.indexOf('\"') === 0) {\r\n        key = '';\r\n        name = namespace.replace(/[\\'\\\"]/g, '');\r\n    }\r\n\r\n    if (name && name.includes('.') && key.length) {\r\n        if (!container[key])\r\n            container[key] = {};\r\n        wrap(name, container[key], value);\r\n    } else if (key.length) {\r\n        if (!container[key])\r\n            container[key] = {};\r\n        container[key][name] = value;\r\n    } else {\r\n        container[name] = value;\r\n    }\r\n\r\n    return container;\r\n}\r\n\r\nfunction wrapNamespaces(obj) {\r\n    for (let key in obj) {\r\n        if (key.includes('.')) {\r\n            wrap(key, obj, obj[key]);\r\n            delete obj[key];\r\n        }\r\n    }\r\n\r\n    return obj;\r\n}\r\n\r\nfunction prepareCondition(conditions) {\r\n    let result = {};\r\n    for (let condition of conditions) {\r\n        let tmp, rule = compileCondition(condition);\r\n        if (rule[1] === '=' || rule[1] === '==') {\r\n            tmp = createCondition(rule[2]);\r\n        } else {\r\n            tmp = [rule[1], createCondition(rule[2])];\r\n        }\r\n\r\n        if (result[rule[0]] === undefined) {\r\n            result[rule[0]] = tmp;\r\n        } else {\r\n            if (!Array.isArray(result[rule[0]])) {\r\n                result[rule[0]] = [result[rule[0]]];\r\n                result[rule[0]].flag = true; // notification flag\r\n            }\r\n            result[rule[0]].push(tmp);\r\n        }\r\n    }\r\n    return wrapNamespaces(result);\r\n}\r\n\r\nfunction calculateCondition(target, source, data) {\r\n    for (let key in source) {\r\n        if (Array.isArray(source[key]) && !source[key].flag) {\r\n            target[key] = [source[key][0]];\r\n            target[key].push(source[key][1](data.user, data.action, data.env, data.resource));\r\n        } else if (typeof source[key] === 'function') {\r\n            target[key] = source[key](data.user, data.action, data.env, data.resource);\r\n        } else if (Array.isArray(source[key])) {\r\n            target[key] = [];\r\n            let result;\r\n            for (let item of source[key]) {\r\n                result = item(data.user, data.action, data.env, data.resource);\r\n                if (result !== null && result !== undefined) {\r\n                    target[key].push(result);\r\n                }\r\n            }\r\n        } else {\r\n            target[key] = {};\r\n            calculateCondition(target[key], source[key], data);\r\n        }\r\n    }\r\n    return target;\r\n}\r\n\r\nexport {\r\n    prepareCondition,\r\n    calculateCondition\r\n}","import files from \"./external\";\r\n\r\nconst namespace = 'PolicyLine_DI';\r\n\r\nconst DI = {\r\n    register(name, fn) {\r\n        global[namespace] = global[namespace] || {};\r\n\r\n        if (typeof name === 'function') {\r\n            global[namespace][name.name] = name;\r\n        } else {\r\n            global[namespace][name] = fn;\r\n        }\r\n    },\r\n\r\n    unregister(name) {\r\n        if (global[namespace] === undefined) {\r\n            return;\r\n        }\r\n\r\n        delete global[namespace][(typeof name === 'function') ? name.name : name];\r\n    },\r\n\r\n    clear() {\r\n        delete global[namespace];\r\n    },\r\n\r\n    loadPresets() {\r\n        for (const fileName in files) {\r\n            for (const fnName in files[fileName]) {\r\n                DI.register(fnName, files[fileName][fnName]);\r\n            }\r\n        }\r\n    }\r\n};\r\n\r\nexport {\r\n    DI,\r\n    namespace\r\n};","/* based on https://www.barkweb.co.uk/blog/how-to-build-a-calculator-in-javascript */\r\nconst operators = ['AND', 'OR', '(', ')'];\r\nconst TYPE = {\r\n    op: 'OP',\r\n    val: 'VAL'\r\n};\r\n\r\nfunction wrapToToken(item) {\r\n    return {\r\n        val: item,\r\n        type: operators.includes(item) ? TYPE.op : TYPE.val\r\n    }\r\n}\r\n\r\nfunction createTokens(expression) {\r\n    const array = expression.split(/\\s+|(?=\\(|\\))|\\b/);\r\n    return array.map(wrapToToken);\r\n}\r\n\r\nfunction infixToRPN(tokens) {\r\n    const queue = [];\r\n    const stack = [];\r\n    const precedence = {\r\n        '(': 10,\r\n        'AND': 30,\r\n        'OR': 20\r\n    };\r\n\r\n    while (tokens.length) {\r\n        const token = tokens.shift();\r\n        const tkPrec = precedence[token.val] || 0;\r\n        let stPrec = stack.length ? precedence[stack[stack.length - 1].val] : 0;\r\n\r\n        if (token.type === TYPE.op && token.val === ')') {\r\n            let op = null;\r\n\r\n            while ((op = stack.pop()).val !== '(') {\r\n                queue.push(op);\r\n            }\r\n        } else if (token.type === TYPE.val) {\r\n            queue.push(token);\r\n        } else if (token.type === TYPE.op && (!stack.length || token.val === '(' || tkPrec > stPrec)) {\r\n            stack.push(token);\r\n        } else {\r\n            while (tkPrec <= stPrec) {\r\n                queue.push(stack.pop());\r\n                stPrec = stack.length ? precedence[stack[stack.length - 1].val] : 0;\r\n            }\r\n\r\n            stack.push(token);\r\n        }\r\n    }\r\n\r\n    while (stack.length) {\r\n        queue.push(stack.pop());\r\n    }\r\n\r\n    return queue;\r\n}\r\n\r\nfunction fillTokens(tokens, data) {\r\n    return tokens.map((item) => {\r\n        if (item.type === TYPE.val) {\r\n            item.res = data[item.val];\r\n            item.val = [item.val];\r\n        }\r\n        return item;\r\n    });\r\n}\r\n\r\nfunction evaluateRPN(tokens) {\r\n    const stack = [];\r\n    let val;\r\n\r\n    while (tokens.length) {\r\n        const token = tokens.shift();\r\n\r\n        if (token.type === TYPE.val) {\r\n            stack.push(token);\r\n            continue;\r\n        }\r\n\r\n        const rhs = stack.pop();\r\n        const lhs = stack.pop();\r\n\r\n        switch (token.val) {\r\n            case 'AND':\r\n                stack.push({\r\n                    type: TYPE.val,\r\n                    val: (rhs.res && lhs.res) ? lhs.val.concat(rhs.val) : [],\r\n                    res: rhs.res && lhs.res\r\n                });\r\n                break;\r\n            case 'OR':\r\n                val = [];\r\n                if (lhs.res) {\r\n                    val = lhs.val;\r\n                } else if (rhs.res) {\r\n                    val = rhs.val;\r\n                }\r\n\r\n                stack.push({\r\n                    type: TYPE.val,\r\n                    val: val,\r\n                    res: rhs.res || lhs.res\r\n                });\r\n                break;\r\n        }\r\n    }\r\n\r\n    return stack.pop();\r\n}\r\n\r\nexport {\r\n    createTokens,\r\n    infixToRPN,\r\n    fillTokens,\r\n    evaluateRPN,\r\n    wrapToToken\r\n}","export default {\r\n    $in: function (array, value) {\r\n        return array.includes(value);\r\n    }\r\n}","import String from './string';\r\nimport Array from './array';\r\nimport Time from './time';\r\n\r\nexport default {\r\n    String,\r\n    Array,\r\n    Time\r\n}","export default {\r\n    $trim: function(str) {\r\n        return str.trim();\r\n    },\r\n\r\n    $uppercase: function (str) {\r\n        return str.toUpperCase();\r\n    },\r\n\r\n    $lowercase: function (str) {\r\n        return str.toLowerCase();\r\n    },\r\n\r\n    $strToInt: function (str) {\r\n        return parseInt(str, 10);\r\n    }\r\n}","import moment from 'moment';\r\n\r\nexport default {\r\n    // \"HH:mm a\"\r\n    $timeBetween(time, start, end) {\r\n        let currentTime = moment(time, \"HH:mm a\");\r\n        let startTime = moment(start, \"HH:mm a\");\r\n        let endTime = moment(end, \"HH:mm a\");\r\n\r\n        if ((startTime.hour() >= 12 && endTime.hour() <= 12) || endTime.isBefore(startTime)) {\r\n            endTime.add(1, \"days\"); // handle spanning days endTime\r\n\r\n            if (currentTime.hour() <= 12) {\r\n                currentTime.add(1, \"days\"); // handle spanning days currentTime\r\n            }\r\n        }\r\n\r\n        return currentTime.isBetween(startTime, endTime);\r\n    },\r\n\r\n    // return moment instance for target or comparison\r\n    $moment(date, pattern) {\r\n        if (pattern === 'unix') {\r\n            return moment.unix(date);\r\n        }\r\n        return moment(date, pattern);\r\n    },\r\n\r\n    // extract day number from timestamp value in 'week' or 'month'\r\n    $day(val, param = 'month') {\r\n        let day = moment.unix(val);\r\n        switch (param) {\r\n            case 'week':\r\n                day = day.day();\r\n                break;\r\n            default:\r\n                day = day.date();\r\n        }\r\n        return day;\r\n    },\r\n\r\n    // extract week number from timestamp value in 'month' or 'year'\r\n    $week(val, param = 'month') {\r\n        let week = moment.unix(val);\r\n        if (param === 'year') {\r\n            // localized week of the year\r\n            week = week.week();\r\n        } else {\r\n            week = Math.ceil(week.date() / 7);\r\n        }\r\n\r\n        return week;\r\n    },\r\n\r\n    // extract month number from timestamp value\r\n    $month(val) {\r\n        return moment.unix(val).month();\r\n    },\r\n\r\n    // extract quarter number from timestamp value\r\n    $quarter(val) {\r\n        return moment.unix(val).quarter();\r\n    },\r\n\r\n    // extract year from timestamp value\r\n    $year(val) {\r\n        return moment.unix(val).year()\r\n    },\r\n\r\n    // translate data to timestamp UTC value by pattern\r\n    $dataToTimestamp(val, pattern) {\r\n        return parseInt(moment(val, pattern).format('X'), 10);\r\n    }\r\n}","import {compilePolicy, settings} from './target';\r\nimport {prepareCondition, calculateCondition} from './condition';\r\nimport {\r\n    createTokens,\r\n    infixToRPN,\r\n    fillTokens,\r\n    evaluateRPN,\r\n    wrapToToken\r\n} from './expression';\r\nimport {mergeDeep} from './utils';\r\nimport {DI} from \"./di\";\r\n\r\nlet property = Symbol();\r\nlet calcResult = Symbol();\r\n\r\nclass Policy {\r\n    _groupConstructor(origin) {\r\n        this._expression = infixToRPN(createTokens(origin.expression));\r\n\r\n        this._targets = {};\r\n        this._conditions = {};\r\n        for (const key in origin.policies) {\r\n            let {target, algorithm, effect, condition} = origin.policies[key];\r\n            this._targets[key] = compilePolicy(target, algorithm, effect);\r\n            this._conditions[key] = prepareCondition(condition || []);\r\n        }\r\n    }\r\n\r\n    _singleConstructor(target, algorithm, effect, condition) {\r\n        let uniqID = Math.random().toString(36).substr(2, 9);\r\n\r\n        this._expression = [wrapToToken(uniqID)];\r\n        this._targets = {\r\n            [uniqID]: compilePolicy(target, algorithm, effect)\r\n        };\r\n        this._conditions = {\r\n            [uniqID]: prepareCondition(condition || [])\r\n        };\r\n    }\r\n\r\n    _mergeConstructor(origin, source, operation) {\r\n        this._expression = origin._expression.concat(source._expression, wrapToToken(operation));\r\n        this._targets = Object.assign({}, origin._targets, source._targets);\r\n        this._conditions = Object.assign({}, origin._conditions, source._conditions);\r\n    }\r\n\r\n    constructor(origin, source, effect) {\r\n        if (origin.policies !== undefined) {\r\n            this._groupConstructor(origin);\r\n        } else if (source === undefined && effect === undefined) {\r\n            this._singleConstructor(origin.target, origin.algorithm, origin.effect, origin.condition);\r\n        } else {\r\n            this._mergeConstructor(origin, source, effect);\r\n        }\r\n\r\n        // private container for 'condition' part\r\n        this[property] = {};\r\n    }\r\n\r\n    check(user, action, env, resource) {\r\n        let result = {};\r\n        for (const key in this._targets) {\r\n            result[key] = this._targets[key](user, action, env, resource);\r\n        }\r\n\r\n        // save data for 'condition'\r\n        this[property] = {user, action, env, resource};\r\n        this[calcResult] = evaluateRPN(fillTokens(this._expression, result));\r\n\r\n        return this[calcResult].res;\r\n    }\r\n\r\n    condition(user, action, env, resource) {\r\n        if (!this[calcResult].res) {\r\n            return;\r\n        }\r\n\r\n        let data = {\r\n            user: mergeDeep(user, this[property].user),\r\n            action: mergeDeep(action, this[property].action),\r\n            env: mergeDeep(env, this[property].env),\r\n            resource: mergeDeep(resource, this[property].resource)\r\n        };\r\n        this[property] = {};\r\n\r\n        try {\r\n            let conditions = {}, condition = {};\r\n            for (const key in this._conditions) {\r\n                try {\r\n                    conditions[key] = calculateCondition({}, this._conditions[key], data);\r\n                } catch (error) {\r\n                    // important to close error in calculate condition\r\n                }\r\n            }\r\n\r\n            let array = Object.entries(conditions);\r\n            array.forEach((item) => {\r\n                if (this[calcResult].val.includes(item[0])) {\r\n                    mergeDeep(condition, item[1]);\r\n                }\r\n            });\r\n\r\n            data.condition = mergeDeep(condition, data.resource);\r\n        } catch (e) {\r\n            data = e;\r\n        }\r\n        this[calcResult] = {};\r\n\r\n        return data;\r\n    }\r\n\r\n    and(policy) {\r\n        return new Policy(this, policy, 'AND');\r\n    }\r\n\r\n    or(policy) {\r\n        return new Policy(this, policy, 'OR');\r\n    }\r\n}\r\n\r\n// service DI\r\nDI.loadPresets();\r\n\r\nexport {\r\n    Policy,\r\n    DI,\r\n    settings\r\n}","import {namespace} from \"./di\";\r\n\r\nconst settings = {\r\n    log: false\r\n};\r\n\r\nfunction compileTarget(rule) {\r\n    let ruleReg = /([^<>=!]+)\\s?([<>=!]{1,2})\\s?(.+)/;\r\n    try {\r\n        let ruleArray = ruleReg.exec(rule);\r\n        if (ruleArray) {\r\n            ruleArray = ruleArray.slice(1, 4);\r\n            if (ruleArray[1] === '=' || ruleArray[1] === '==') {\r\n                ruleArray[1] = '==='\r\n            }\r\n            rule = ruleArray.join('');\r\n        }\r\n\r\n        // DI section\r\n        let di = '';\r\n        if (global[namespace] !== undefined) {\r\n            for (const key in global[namespace]) {\r\n                if (rule.includes(key)) {\r\n                    di += 'var ' + key + '=' + namespace + '.' + key + ';';\r\n                }\r\n            }\r\n        }\r\n\r\n        // create returning function\r\n        return new Function('user', 'action', 'env', 'resource',\r\n            'var _a;' + di + 'try{_a=!!(' + rule + ');}catch(_e){_a=_e};return _a;');\r\n    } catch (e) {\r\n        return new Function('return new Error(\"in access rule: ' + rule + '\");');\r\n    }\r\n}\r\n\r\nfunction compilePolicy(target = [], algorithm = 'all', effect = 'deny') {\r\n    let flag = !(algorithm === 'any');\r\n    let rules = [];\r\n    let deny = effect === \"deny\";\r\n\r\n    target.forEach((rule) => {\r\n        rules.push(compileTarget(rule));\r\n    });\r\n\r\n    return function (user, action, env, resource) {\r\n        let result = flag;\r\n\r\n        for (let rule of rules) {\r\n            let ruleResult = rule(user, action, env, resource);\r\n\r\n            // any case with errors to deny of whole policy\r\n            if (typeof ruleResult === 'object') {\r\n                if (settings.log) {\r\n                    console.error(ruleResult);\r\n                }\r\n                return false;\r\n            }\r\n\r\n            // using the algorithm\r\n            result = flag ? (result && ruleResult) : (result || ruleResult);\r\n        }\r\n\r\n        return deny ? !result : result;\r\n    }\r\n}\r\n\r\nexport {compilePolicy, settings};","function isObject(item) {\r\n    return (item\r\n        && typeof item === 'object'\r\n        && !Array.isArray(item)\r\n        && !(item instanceof RegExp));\r\n}\r\n\r\nfunction mergeDeep(target, source) {\r\n    if (isObject(target) && isObject(source)) {\r\n        for (const key in source) {\r\n            if (isObject(source[key])) {\r\n                if (!target[key]) {\r\n                    target[key] = {};\r\n                }\r\n                mergeDeep(target[key], source[key]);\r\n            } else {\r\n                target[key] = source[key];\r\n            }\r\n        }\r\n    }\r\n    return target || source;\r\n}\r\n\r\nexport {\r\n    mergeDeep\r\n}","module.exports = require(\"moment\");"],"sourceRoot":""}